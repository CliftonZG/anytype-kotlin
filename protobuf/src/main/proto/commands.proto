syntax = "proto3";
package anytype;
option go_package = "pb";

import "models.proto";
import "google/protobuf/struct.proto";

/*
 * Rpc is a namespace, that agregates all of the service commands between client and middleware.
 * Structure: Topic > Subtopic > Subsub... > Action > (Request, Response).
 * Request – message from a client.
 * Response – message from a middleware.
*/
message Rpc {
    message BlockList {

        message Move {
            message Request {
                string contextId = 1;
                repeated string blockIds = 2;
                string dropTargetId = 3;
                anytype.model.Block.Position position = 4;
            }

            message Response {
                Error error = 1;

                message Error {
                    Code code = 1;
                    string description = 2;

                    enum Code {
                        NULL = 0;
                        UNKNOWN_ERROR = 1;
                        BAD_INPUT = 2;
                        // ...
                    }
                }
            }
        }

        message Set {
            message Text {
                message Style {
                    message Request {
                        string contextId = 1;
                        repeated string blockIds = 2;
                        anytype.model.Block.Content.Text.Style style = 3;
                    }

                    message Response {
                        Error error = 1;

                        message Error {
                            Code code = 1;
                            string description = 2;

                            enum Code {
                                NULL = 0;
                                UNKNOWN_ERROR = 1;
                                BAD_INPUT = 2;
                                // ...
                            }
                        }
                    }
                }
            }
        }
    }

    /*
     * Namespace, that agregates subtopics and actions, that relates to blocks.
    */
    message Block {
        message Split {
            message Request {
                string contextId = 1;
                string blockId = 2;
                int32 cursorPosition = 3;
            }

            message Response {
                Error error = 1;

                message Error {
                    Code code = 1;
                    string description = 2;

                    enum Code {
                        NULL = 0;
                        UNKNOWN_ERROR = 1;
                        BAD_INPUT = 2;
                        // ...
                    }
                }
            }
        }

        message Merge {
            message Request {
                string contextId = 1;
                string firstBlockId = 2;
                string secondBlockId = 3;
            }

            message Response {
                Error error = 1;

                message Error {
                    Code code = 1;
                    string description = 2;

                    enum Code {
                        NULL = 0;
                        UNKNOWN_ERROR = 1;
                        BAD_INPUT = 2;
                        // ...
                    }
                }
            }
        }

        message Duplicate {
            message Request {
                string contextId = 1;
                string blockId = 2;
            }

            message Response {
                Error error = 1;

                message Error {
                    Code code = 1;
                    string description = 2;

                    enum Code {
                        NULL = 0;
                        UNKNOWN_ERROR = 1;
                        BAD_INPUT = 2;
                        // ...
                    }
                }
            }
        }

        message Copy {
            message Request {
                string contextId = 1;
                string focusedBlockId = 2;
                anytype.model.Range selectedTextRange = 3;
                repeated string selectedBlocks = 4;
            }

            message Response {
                Error error = 1;
                string clipboardText = 2;
                string clipboardHtml = 3;
                string clipboardAny = 4; // TODO: type – is string ok?

                message Error {
                    Code code = 1;
                    string description = 2;

                    enum Code {
                        NULL = 0;
                        UNKNOWN_ERROR = 1;
                        BAD_INPUT = 2;
                        // ...
                    }
                }
            }
        }

        message Paste {
            message Request {
                string contextId = 1;
                string focusedBlockId = 2;
                anytype.model.Range selectedTextRange = 3;
                repeated string selectedBlocks = 4;

                string clipboardText = 5;
                string clipboardHtml = 6;
                string clipboardAny = 7;
            }

            message Response {
                Error error = 1;

                message Error {
                    Code code = 1;
                    string description = 2;

                    enum Code {
                        NULL = 0;
                        UNKNOWN_ERROR = 1;
                        BAD_INPUT = 2;
                        // ...
                    }
                }
            }
        }

        message Upload {
            message Request {
                string contextId = 1;
                string blockId = 2;
                string localPath = 3;
                string url = 4;
            }

            message Response {
                Error error = 1;

                message Error {
                    Code code = 1;
                    string description = 2;

                    enum Code {
                        NULL = 0;
                        UNKNOWN_ERROR = 1;
                        BAD_INPUT = 2;
                        // ...
                    }
                }
            }
        }

        message Download {
            message Request {
                string contextId = 1;
                string blockId = 2;
            }

            message Response {
                Error error = 1;

                message Error {
                    Code code = 1;
                    string description = 2;

                    enum Code {
                        NULL = 0;
                        UNKNOWN_ERROR = 1;
                        BAD_INPUT = 2;
                        // ...
                    }
                }
            }
        }

        message Set {
            message Fields {
                message Request {
                    string contextId = 1;
                    string blockId = 2;
                    google.protobuf.Struct fields = 3;
                }

                message Response {
                    Error error = 1;

                    message Error {
                        Code code = 1;
                        string description = 2;

                        enum Code {
                            NULL = 0;
                            UNKNOWN_ERROR = 1;
                            BAD_INPUT = 2;
                            // ...
                        }
                    }
                }
            }

            message Restrictions {
                message Request {
                    string contextId = 1;
                    string blockId = 2;
                    anytype.model.Block.Restrictions restrictions = 3;
                }

                message Response {
                    Error error = 1;

                    message Error {
                        Code code = 1;
                        string description = 2;

                        enum Code {
                            NULL = 0;
                            UNKNOWN_ERROR = 1;
                            BAD_INPUT = 2;
                            // ...
                        }
                    }
                }
            }

            message IsArchived {
                message Request {
                    string contextId = 1;
                    string blockId = 2;
                    bool IsArchived = 3;
                }

                message Response {
                    Error error = 1;

                    message Error {
                        Code code = 1;
                        string description = 2;

                        enum Code {
                            NULL = 0;
                            UNKNOWN_ERROR = 1;
                            BAD_INPUT = 2;
                            // ...
                        }
                    }
                }
            }

            message Text {

                message Editable {
                    message Request {
                        string contextId = 1;
                        string blockId = 2;
                        string text = 3;
                        anytype.model.Block.Content.Text.Marks marks = 4;
                    }

                    message Response {
                        Error error = 1;

                        message Error {
                            Code code = 1;
                            string description = 2;

                            enum Code {
                                NULL = 0;
                                UNKNOWN_ERROR = 1;
                                BAD_INPUT = 2;
                                // ...
                            }
                        }
                    }
                }

                message Style {
                    message Request {
                        string contextId = 1;
                        string blockId = 2;
                        anytype.model.Block.Content.Text.Style style = 3;
                    }

                    message Response {
                        Error error = 1;

                        message Error {
                            Code code = 1;
                            string description = 2;

                            enum Code {
                                NULL = 0;
                                UNKNOWN_ERROR = 1;
                                BAD_INPUT = 2;
                                // ...
                            }
                        }
                    }
                }

                message Checked {
                    message Request {
                        string contextId = 1;
                        string blockId = 2;
                        bool checked = 3;
                    }

                    message Response {
                        Error error = 1;

                        message Error {
                            Code code = 1;
                            string description = 2;

                            enum Code {
                                NULL = 0;
                                UNKNOWN_ERROR = 1;
                                BAD_INPUT = 2;
                                // ...
                            }
                        }
                    }
                }
            }

            message File {
                message Name {
                    message Request {
                        string contextId = 1;
                        string blockId = 2;
                        string name = 3;
                    }

                    message Response {
                        Error error = 1;

                        message Error {
                            Code code = 1;
                            string description = 2;

                            enum Code {
                                NULL = 0;
                                UNKNOWN_ERROR = 1;
                                BAD_INPUT = 2;
                                // ...
                            }
                        }
                    }
                }
            }

            message Image {
                message Name {
                    message Request {
                        string contextId = 1;
                        string blockId = 2;
                        string name = 3;
                    }

                    message Response {
                        Error error = 1;

                        message Error {
                            Code code = 1;
                            string description = 2;

                            enum Code {
                                NULL = 0;
                                UNKNOWN_ERROR = 1;
                                BAD_INPUT = 2;
                                // ...
                            }
                        }
                    }
                }

                message Width {
                    message Request {
                        string contextId = 1;
                        string blockId = 2;
                        int32 width = 3;
                    }

                    message Response {
                        Error error = 1;

                        message Error {
                            Code code = 1;
                            string description = 2;

                            enum Code {
                                NULL = 0;
                                UNKNOWN_ERROR = 1;
                                BAD_INPUT = 2;
                                // ...
                            }
                        }
                    }
                }
            }

            message Video {
                message Name {
                    message Request {
                        string contextId = 1;
                        string blockId = 2;
                        string name = 3;
                    }

                    message Response {
                        Error error = 1;

                        message Error {
                            Code code = 1;
                            string description = 2;

                            enum Code {
                                NULL = 0;
                                UNKNOWN_ERROR = 1;
                                BAD_INPUT = 2;
                                // ...
                            }
                        }
                    }
                }

                message Width {
                    message Request {
                        string contextId = 1;
                        string blockId = 2;
                        int32 width = 3;
                    }

                    message Response {
                        Error error = 1;

                        message Error {
                            Code code = 1;
                            string description = 2;

                            enum Code {
                                NULL = 0;
                                UNKNOWN_ERROR = 1;
                                BAD_INPUT = 2;
                                // ...
                            }
                        }
                    }
                }
            }

            message Icon {
                message Name {
                    message Request {
                        string contextId = 1;
                        string blockId = 2;
                        string name = 3;
                    }

                    message Response {
                        Error error = 1;

                        message Error {
                            Code code = 1;
                            string description = 2;

                            enum Code {
                                NULL = 0;
                                UNKNOWN_ERROR = 1;
                                BAD_INPUT = 2;
                                // ...
                            }
                        }
                    }
                }
            }
        }

        message Get {
            /*
             * Get marks list in the selected range in text block.
            */
            message Marks {
                message Request {
                    string contextId = 1;
                    string blockId = 2;
                    anytype.model.Range range = 3;
                }

                message Response {
                    Error error = 1;

                    message Error {
                        Code code = 1;
                        string description = 2;

                        enum Code {
                            NULL = 0;
                            UNKNOWN_ERROR = 1;
                            BAD_INPUT = 2;
                            // ...
                        }
                    }
                }
            }
        }

        /*
         * Block history: switch between versions (lib context: switch block head), move forward or backward
         * **Example scenario**
         * 1. User -> MacOS Front: CMD+Z
         * 2. Front -> MW: Rpc.Block.History.Move.Request(blockId, false)
         * 3. MW -> Lib: ?? TODO
         * 4. Lib: switches current block header to a previous one
         * 5. Lib -> MW: prev version of block
         * 6. MW -> Front: BlockShow(block.prevVersion)
        */
        message History {
            message Move {
                message Request {
                    string contextId = 1; // id of the context block
                    string blockId = 2;
                    bool moveForward = 3; // Move direction. If true, move forward
                }

                message Response {
                    Error error = 1;

                    message Error {
                        Code code = 1;
                        string description = 2;

                        enum Code {
                            NULL = 0;
                            UNKNOWN_ERROR = 1;
                            BAD_INPUT = 2;
                            CAN_NOT_MOVE = 3;
                            // ...
                        }
                    }
                }
            }
        }

        /*
         * Works with a smart blocks (block-organizers, like page, dashboard etc)
         * **Example scenario**
         * 1A. On front-end start.
         *     1. Front -> MW: Rpc.Block.Open.Request(dashboard.id)
         *     2. MW -> Front: BlockShow(dashboard)
         *     3. MW -> Front: Rpc.Block.Open.Response(err)
         * 1B. User clicks on a page icon on the dashboard.
         *     1. Front -> MW: Rpc.Block.Close.Request(dashboard.id)
         * Get close response first, then open request:
         *     2. MW -> Front: Rpc.Block.Close.Response(err)
         *     3. Front -> MW: Rpc.Block.Open.Request(page.id)
         *     4. MW -> Front: BlockShow(<page, blocks>)
         *     5. MW -> Front: Rpc.Block.Open.Response(err)
         * Image/Video/File blocks then:
         *     6. MW -> Front: BlockShow(<blocks>)
        */
        message Open {
            message Request {
                string contextId = 1; // id of the context blo1k
                string blockId = 2;
            }

            message Response {
                Error error = 1;

                message Error {
                    Code code = 1;
                    string description = 2;

                    enum Code {
                        NULL = 0;
                        UNKNOWN_ERROR = 1;
                        BAD_INPUT = 2;
                        // ...
                    }
                }
            }
        }

        /*
         * Create a Smart/Internal block. Request can contain a block with a content, or it can be an empty block with a specific block.content.
         * **Example scenario**
         * 1A. Create Page on a dashboard
         *     1. Front -> MW: Rpc.Block.Create.Request(blockId:dashboard.id, position:after, block: emtpy block with page content and id = "")
         *     2. Front -> MW: Rpc.Block.Close.Request(block: dashboard.id)
         *     3. Front <- MW: Rpc.Block.Close.Response(err)
         *     4. Front <- MW: Rpc.Block.Create.Response(page.id)
         *     5. Front <- MW: Rpc.Block.Open.Response(err)
         *     6. Front <- MW: Event.Block.Show(page)
         * 1B. Create Page on a Page
         *     1. Front -> MW: Rpc.Block.Create.Request(blockId:dashboard.id, position:after, block: emtpy block with page content and id = "")
         *     2. Front <- MW: Rpc.Block.Create.Response(newPage.id)
         *     3. Front <- MW: Event.Block.Show(newPage)
        */
        message Create {
            message Request {
                string contextId = 1; // id of the context block
                string targetId = 2; // id of the closest block
                anytype.model.Block block = 3;
                anytype.model.Block.Position position = 4;
                string parentId = 5; // id of the parent block
            }

            message Response {
                Error error = 1;
                string blockId = 2;

                message Error {
                    Code code = 1;
                    string description = 2;

                    enum Code {
                        NULL = 0;
                        UNKNOWN_ERROR = 1;
                        BAD_INPUT = 2;
                        // ...
                    }
                }
            }
        }

        /*
         * Remove blocks from the childrenIds of its parents
        */
        message Unlink {
            message Request {
                string contextId = 1; // id of the context block
                repeated Target targets = 2; // targets to remove

                message Target {
                    string blockId = 1; // id of the block to remove
                    string parentId = 2; // id of the parent block
                }
            }

            message Response {
                Error error = 1;

                message Error {
                    Code code = 1;
                    string description = 2;

                    enum Code {
                        NULL = 0;
                        UNKNOWN_ERROR = 1;
                        BAD_INPUT = 2;
                        // ...
                    }
                }
            }
        }

        /*
         * Block.Close – it means unsubscribe from a block.
         * Precondition: block should be opened.
        */
        message Close {
            message Request {
                string contextId = 1; // id of the context blo1k
                string blockId = 2;
            }

            message Response {
                Error error = 1;

                message Error {
                    Code code = 1;
                    string description = 2;

                    enum Code {
                        NULL = 0;
                        UNKNOWN_ERROR = 1;
                        BAD_INPUT = 2;
                        // ...
                    }
                }
            }
        }
    }

    /*
     * Namespace, that agregates subtopics and actions, that relates to wallet.
    */
    message Wallet {
        message Create {
            /**
            * Front-end-to-middleware request to create a new wallet
            */
            message Request {
                string rootPath = 1; // Path to a wallet directory
            }

            /**
            * Middleware-to-front-end response, that can contain mnemonic of a created account and a NULL error or an empty mnemonic and a non-NULL error
            */
            message Response {
                Error error = 1;
                string mnemonic = 2; // Mnemonic of a new account (sequence of words, divided by spaces)

                message Error {
                    Code code = 1;
                    string description = 2;

                    enum Code {
                        NULL = 0; // No error; mnemonic should be non-empty
                        UNKNOWN_ERROR = 1; // Any other errors
                        BAD_INPUT = 2; // Root path is wrong

                        FAILED_TO_CREATE_LOCAL_REPO = 101;
                        // ...
                    }
                }
            }
        }

        message Recover {
            /**
            * Front end to middleware request-to-recover-a wallet with this mnemonic and a rootPath
            */
            message Request {
                string rootPath = 1; // Path to a wallet directory
                string mnemonic = 2; // Mnemonic of a wallet to recover
            }

            /**
            * Middleware-to-front-end response, that can contain a NULL error or a non-NULL error
            */
            message Response {
                Error error = 1; // Error while trying to recover a wallet
                message Error {
                    Code code = 1;
                    string description = 2;

                    enum Code {
                        NULL = 0; // No error; wallet successfully recovered
                        UNKNOWN_ERROR = 1; // Any other errors
                        BAD_INPUT = 2; // Root path or mnemonic is wrong

                        FAILED_TO_CREATE_LOCAL_REPO = 101;
                    }
                }
            }
        }
    }

    /*
     * Namespace, that agregates subtopics and actions, that relates to account.
    */
    message Account {
        message Create {
            /**
            * Front end to middleware request-to-create-an account
            */
            message Request {
                string name = 1; // Account name
                oneof avatar {
                    string avatarLocalPath = 2; // Path to an image, that will be used as an avatar of this account
                    string avatarColor = 3; // Avatar color as an alternative for avatar image
                }
            }

            /**
            * Middleware-to-front-end response for an account creation request, that can contain a NULL error and created account or a non-NULL error and an empty account
            */
            message Response {
                Error error = 1; // Error while trying to create an account
                anytype.model.Account account = 2; // A newly created account; In case of a failure, i.e. error is non-NULL, the account model should contain empty/default-value fields

                message Error {
                    Code code = 1;
                    string description = 2;

                    enum Code {
                        NULL = 0; // No error; Account should be non-empty
                        UNKNOWN_ERROR = 1; // Any other errors
                        BAD_INPUT = 2; // Avatar or name is not correct

                        ACCOUNT_CREATED_BUT_FAILED_TO_START_NODE = 101;
                        ACCOUNT_CREATED_BUT_FAILED_TO_SET_NAME = 102;
                        ACCOUNT_CREATED_BUT_FAILED_TO_SET_AVATAR = 103;
                    }
                }
            }
        }

        message Recover {
            /**
            * Front end to middleware request-to-start-search of an accounts for a recovered mnemonic.
            * Each of an account that would be found will come with an AccountAdd event
            */
            message Request {
            }

            /**
            * Middleware-to-front-end response to an account recover request, that can contain a NULL error and created account or a non-NULL error and an empty account
            */
            message Response {
                Error error = 1; // Error while trying to recover an account
                message Error {
                    Code code = 1;
                    string description = 2;

                    enum Code {
                        NULL = 0; // No error;
                        UNKNOWN_ERROR = 1; // Any other errors
                        BAD_INPUT = 2;

                        NO_ACCOUNTS_FOUND = 101;
                        NEED_TO_RECOVER_WALLET_FIRST = 102;
                        FAILED_TO_CREATE_LOCAL_REPO = 103;
                        LOCAL_REPO_EXISTS_BUT_CORRUPTED = 104;
                        FAILED_TO_RUN_NODE = 105;
                        WALLET_RECOVER_NOT_PERFORMED = 106;
                    }
                }
            }
        }

        message Select {
            /**
            * Front end to middleware request-to-launch-a specific account using account id and a root path
            * User can select an account from those, that came with an AccountAdd events
            */
            message Request {
                string id = 1; // Id of a selected account
                string rootPath = 2; // Root path is optional, set if this is a first request
            }

            /**
            * Middleware-to-front-end response for an account select request, that can contain a NULL error and selected account or a non-NULL error and an empty account
            */
            message Response {
                Error error = 1; // Error while trying to launch/select an account
                anytype.model.Account account = 2; // Selected account

                message Error {
                    Code code = 1;
                    string description = 2;

                    enum Code {
                        NULL = 0; // No error
                        UNKNOWN_ERROR = 1; // Any other errors
                        BAD_INPUT = 2; // Id or root path is wrong

                        FAILED_TO_CREATE_LOCAL_REPO = 101;
                        LOCAL_REPO_EXISTS_BUT_CORRUPTED = 102;
                        FAILED_TO_RUN_NODE = 103;
                        FAILED_TO_FIND_ACCOUNT_INFO = 104;
                        LOCAL_REPO_NOT_EXISTS_AND_MNEMONIC_NOT_SET = 105;
                    }
                }
            }
        }
    }

    /*
     * Namespace, that agregates log subtopics and actions.
     * Usage: send request with topic (Level) and description (message) from client to middleware to log.
    */
    message Log {
        message Send {
            message Request {
                string message = 1;
                Level level = 2;

                enum Level {
                    DEBUG = 0;
                    ERROR = 1;
                    FATAL = 2;
                    INFO = 3;
                    PANIC = 4;
                    WARNING = 5;
                }
            }

            message Response {
                Error error = 1;

                message Error {
                    Code code = 1;
                    string description = 2;

                    enum Code {
                        NULL = 0;
                        UNKNOWN_ERROR = 1;
                        BAD_INPUT = 2;

                        NOT_FOUND = 101;
                        TIMEOUT = 102;
                    }
                }
            }
        }
    }

    /*
     * Get info about a version of a middleware.
     * Info is a string, that contains: BuildDate, GitCommit, GitBranch, GitState
    */
    message Version {
        message Get {
            message Request {
            }

            message Response {
                Error error = 1;
                string version = 2; // BuildDate, GitCommit, GitBranch, GitState

                message Error {
                    Code code = 1;
                    string description = 2;

                    enum Code {
                        NULL = 0;
                        UNKNOWN_ERROR = 1;
                        BAD_INPUT = 2;
                        VERSION_IS_EMPTY = 3;

                        NOT_FOUND = 101;
                        TIMEOUT = 102;
                    }
                }
            }
        }
    }

    /*
     * Namespace, that agregates subtopics and actions to work with IPFS directly (get files, blobs, images, etc)
    */
    message Ipfs {
        message File {
            message Get {
                message Request {
                    string id = 1;
                }

                message Response {
                    Error error = 1;
                    bytes data = 2;
                    string media = 3;
                    string name = 4;
                    message Error {
                        Code code = 1;
                        string description = 2;

                        enum Code {
                            NULL = 0;
                            UNKNOWN_ERROR = 1;
                            BAD_INPUT = 2;
                            // ...

                            NOT_FOUND = 101;
                            TIMEOUT = 102;
                        }
                    }
                }
            }
        }

        message Image {
            message Get {
                message Blob {
                    message Request {
                        string id = 1;
                        anytype.model.Image.Size size = 2;
                    }

                    message Response {
                        Error error = 1;
                        bytes blob = 2;

                        message Error {
                            Code code = 1;
                            string description = 2;

                            enum Code {
                                NULL = 0;
                                UNKNOWN_ERROR = 1;
                                BAD_INPUT = 2;
                                // ...

                                NOT_FOUND = 101;
                                TIMEOUT = 102;
                            }
                        }
                    }
                }

                message File {
                    message Request {
                        string id = 1;
                        anytype.model.Image.Size size = 2;
                    }

                    message Response {
                        Error error = 1;
                        string localPath = 2;

                        message Error {
                            Code code = 1;
                            string description = 2;

                            enum Code {
                                NULL = 0;
                                UNKNOWN_ERROR = 1;
                                BAD_INPUT = 2;
                                // ...

                                NOT_FOUND = 101;
                                TIMEOUT = 102;
                            }
                        }
                    }
                }
            }
        }
    }

    message Config {
        message Get {
            message Request {
            }
            message Response {
                Error error = 1;
                string homeBlockId = 2;
                message Error {
                    Code code = 1;
                    string description = 2;
                    enum Code {
                        NULL = 0;
                        UNKNOWN_ERROR = 1;
                        BAD_INPUT = 2;
                    }
                }

            }
        }
    }

    message Ping {
        message Request {
            int32 index = 1;
            int32 numberOfEventsToSend = 2;
        }

        message Response {
            Error error = 1;
            int32 index = 2;

            message Error {
                Code code = 1;
                string description = 2;

                enum Code {
                    NULL = 0;
                    UNKNOWN_ERROR = 1;
                    BAD_INPUT = 2;
                }
            }
        }
    }

}
